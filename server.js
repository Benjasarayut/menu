const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const axios = require('axios');

const app = express();
app.use(cors());
app.use(bodyParser.json());

// ==========================================
// ‚ö†Ô∏è ‡πÉ‡∏™‡πà Token ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
const CHANNEL_ACCESS_TOKEN = '4FC23qwpo4NklMYi5W6dgDMU9I3hQexRs6T7A+hvkslOzzlwzpKzSfakAWZiFlFXylvI9HicAv9F/xLJoVLzGC11Xx3RRJihmimr43Zy2MXm3w6In4Vaa94czTR9KVDlcX9jviWRrqyQ9X605gxbtAdB04t89/1O/w1cDnyilFU='; 

// üë• ‡πÇ‡∏ã‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°)
// -------------------------------------------------------

// üëë 1. ‡∏Å‡∏•‡∏∏‡πà‡∏° Admin (‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô / ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)
const ADMIN_IDS = [
    'Uaee9c1eebc0f49f0190de36b4e3d0bdb', // ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ö‡∏ô
    // 'U...‡πÑ‡∏≠‡∏î‡∏µ‡∏´‡∏∏‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô...', 
];

// üë®‚Äçüç≥ 2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / ‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß)
const STAFF_IDS = [
    // 'U...‡πÑ‡∏≠‡∏î‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô1...', 
    // 'U...‡πÑ‡∏≠‡∏î‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô2...',
];

// üì¢ ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà"
// (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤ Admin + Staff ‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô ‡πÉ‡∏Ñ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏î)
const ORDER_RECEIVERS = [...ADMIN_IDS, ...STAFF_IDS]; 

// üü¢ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1)
let dailyQueue = 1; 
// ==========================================

app.post('/api/order', async (req, res) => {
    try {
        // --- ‚è∞ ‡πÇ‡∏ã‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î ---
        /*
        const now = new Date();
        const currentHour = now.getHours(); // ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)

        // ‡∏Å‡∏é: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 19 (‡∏Ñ‡∏∑‡∏≠ 00.00 - 18.59) ‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î
        if (currentHour < 19) {
            console.log("‚õî ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Å‡∏î‡∏™‡∏±‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î: " + currentHour + " ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤");
            return res.json({ status: 'closed', message: '‚õî ‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö\n(‡πÄ‡∏õ‡∏¥‡∏î 19.00 - 00.00 ‡∏ô.)' });
        }
        */
        // ------------------------------------------

        const { name, phone, payment, items, total, type } = req.body;

        // 1. ‚úÖ ‡∏ï‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        const myQueue = dailyQueue;
        dailyQueue++; 

        // 2. ‡∏à‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå
        const message = `
üî¢ ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà: ${myQueue}
üìå ‡πÅ‡∏ö‡∏ö: ${type}
------------------------
üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${name}
üìû ‡πÇ‡∏ó‡∏£: ${phone}
üí≥ ‡∏ä‡∏≥‡∏£‡∏∞: ${payment}
------------------------
${items}
------------------------
üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${total} ‡∏ö‡∏≤‡∏ó`;

        // 3. ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LINE (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Multicast ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏´‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)
        // ‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤ ORDER_RECEIVERS ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏•‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ error (‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ö‡∏ô‡∏≠‡∏¢‡∏π‡πà 1 ‡∏Ñ‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)
        if (ORDER_RECEIVERS.length > 0) {
            await axios.post(
                'https://api.line.me/v2/bot/message/multicast', // ‡πÉ‡∏ä‡πâ multicast ‡πÅ‡∏ó‡∏ô push
                {
                    to: ORDER_RECEIVERS, // ‡∏™‡πà‡∏á‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    messages: [{ type: 'text', text: message }]
                },
                {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CHANNEL_ACCESS_TOKEN}`
                    }
                }
            );
        }

        console.log(`‚úÖ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${myQueue} ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏™‡πà‡∏á‡∏´‡∏≤ ${ORDER_RECEIVERS.length} ‡∏Ñ‡∏ô)`);

        // 4. ‚úÖ ‡∏™‡πà‡∏á‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
        res.json({ status: 'success', queueNumber: myQueue });

    } catch (error) {
        console.error('‚ùå Error:', error.message);
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà ID ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö
        if (error.response && error.response.data) {
             console.error('LINE API Error Details:', JSON.stringify(error.response.data));
        }
        res.status(500).json({ status: 'error' });
    }
});

const PORT = 3000;
app.listen(PORT, () => {
    console.log(`Server running on port ${PORT} üöÄ`);
});