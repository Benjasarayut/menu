<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff POS System</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #d32f2f; --bg: #fff5f5; --white: #ffffff; --green: #2e7d32; --gold: #ffc107; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* Top Bar ‡πÅ‡∏î‡∏á‡∏ó‡∏≠‡∏á */
        .top-bar { background: linear-gradient(135deg, #b71c1c, #d32f2f); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .logo-box h1 { margin: 0; font-size: 20px; font-weight: 600; }
        .logo-box p { margin: 0; font-size: 12px; color: var(--gold); }
        
        /* Layout ‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏ö‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
        .dashboard-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; flex-grow: 1; overflow: hidden; }
        
        /* Panel ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞ */
        .panel-tables { background: var(--white); border-radius: 15px; padding: 20px; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .panel-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; color: var(--primary); display: flex; justify-content: space-between; }
        
        .table-list { display: flex; flex-direction: column; gap: 10px; }
        .table-card { 
            padding: 15px; border-radius: 10px; border: 1px solid #eee; background: white; cursor: pointer; transition: 0.2s; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .table-card:hover { transform: translateX(5px); border-color: var(--primary); }
        .table-card.active-select { background-color: #ffebee; border-color: var(--primary); }
        
        .t-name { font-weight: bold; font-size: 16px; }
        .t-status { font-size: 12px; padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        .status-free { background: #e8f5e9; color: var(--green); border: 1px solid #c8e6c9; }
        .status-busy { background: #ffebee; color: var(--primary); border: 1px solid #ffcdd2; animation: pulse 2s infinite; }

        /* Panel ‡∏Ç‡∏ß‡∏≤: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏• */
        .panel-order { background: var(--white); border-radius: 15px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .order-content { flex-grow: 1; overflow-y: auto; }
        
        .empty-state { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #aaa; }
        
        .bill-header { text-align: center; margin-bottom: 20px; border-bottom: 1px dashed #ccc; padding-bottom: 15px; }
        .bill-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        
        .bill-footer { margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
        .total-row { display: flex; justify-content: space-between; font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 20px; }
        
        .btn-pay { width: 100%; background: var(--green); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-pay:hover { background: #1b5e20; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); } 70% { box-shadow: 0 0 0 5px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="logo-box">
            <h1>Kopihub System</h1>
            <p>Management & POS</p>
        </div>
        <div>
            <span style="font-size:14px; opacity:0.8;">Admin Logged In</span>
        </div>
    </div>

    <div class="dashboard-layout">
        <aside class="panel-tables">
            <div class="panel-header">Table Status <span style="font-size:12px; color:#666;">Live</span></div>
            <div id="tableList" class="table-list">Loading...</div>
        </aside>

        <main class="panel-order">
            <div id="orderDetail" class="empty-state">
                <div style="font-size:40px;">üçΩÔ∏è</div>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            </div>
        </main>
    </div>

    <script>
        let allTables = {};
        let selectedTableId = null;

        setInterval(fetchData, 3000);
        fetchData();

        async function fetchData() {
            try {
                const res = await fetch('https://menu-tmrx.onrender.com/api/admin/tables');
                allTables = await res.json();
                renderTableList();
                if (selectedTableId) renderOrderDetail(selectedTableId); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
            } catch (err) { console.error("Sync Error"); }
        }

        function renderTableList() {
            const container = document.getElementById("tableList");
            let html = "";
            for (let i = 1; i <= 8; i++) {
                const t = allTables[i];
                const isBusy = (t.status !== 'empty');
                const activeClass = (selectedTableId == i) ? 'active-select' : '';
                
                html += `
                <div class="table-card ${activeClass}" onclick="selectTable(${i})">
                    <div>
                        <div class="t-name">Table ${i.toString().padStart(2, '0')}</div>
                        <div style="font-size:12px; color:#666;">${isBusy ? t.items.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : '‡∏ß‡πà‡∏≤‡∏á'}</div>
                    </div>
                    <div class="t-status ${isBusy ? 'status-busy' : 'status-free'}">
                        ${isBusy ? 'Occupied' : 'Available'}
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        function selectTable(id) {
            selectedTableId = id;
            renderTableList(); // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            renderOrderDetail(id);
        }

        function renderOrderDetail(id) {
            const container = document.getElementById("orderDetail");
            const data = allTables[id];

            if (!data || data.status === 'empty') {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size:60px; color:#ddd;">‚úÖ</div>
                        <h2 style="color:#2e7d32;">Table ${id} is Available</h2>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</p>
                    </div>`;
                return;
            }

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            let itemsHtml = data.items.map(item => `
                <div class="bill-item">
                    <span>${item.name} <small style="color:#888;">x${item.qty}</small></span>
                    <span>${item.price * item.qty}</span>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="order-content">
                    <div class="bill-header">
                        <h2 style="margin:0;">Table ${id.toString().padStart(2, '0')}</h2>
                        <span style="color:var(--primary); font-weight:bold;">Status: Unpaid</span>
                    </div>
                    <div style="padding:0 20px;">
                        <h3 style="margin-bottom:10px;">Current Order</h3>
                        ${itemsHtml}
                    </div>
                </div>
                <div class="bill-footer">
                    <div class="total-row">
                        <span>Total Amount</span>
                        <span>${data.total} THB</span>
                    </div>
                    <button class="btn-pay" onclick="clearTable(${id})">üí∞ CONFIRM PAYMENT</button>
                </div>
            `;
        }

        async function clearTable(id) {
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏ï‡πä‡∏∞ ${id} ?`)) return;
            await fetch('https://menu-tmrx.onrender.com/api/admin/clear-table', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tableNo: id })
            });
            selectedTableId = null; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏ß‡∏≤
            renderOrderDetail(null); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
            fetchData(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        }
    </script>
</body>
</html>